# KTC Photo Bot

Telegram-бот для редактирования фотографий с помощью AI-сервисов (OpenAI и Google Vision). Реализован на Python с использованием aiogram, OpenCV и Pillow.

## Содержимое репозитория

- `bot.py` — основной входной файл бота и логика FSM
- `example.py` — пример использования / вспомогательные скрипты
- пакет `from google` — помощники для интеграции с Google

## Возможности

- Приём фотографий от пользователей Telegram и применение AI-редактирования
- Поддержка OpenAI Image Edit API и обработки через Google Vision
- Локальная предобработка изображений с OpenCV / Pillow и управление временными файлами
- Диалог на основе конечного автомата (FSM) из aiogram с хранилищем в памяти

## Требования

- Python 3.10+ (рекомендуется)
- ОС: Windows / Linux / macOS (цель разработки: Windows)

## Переменные окружения

Создайте файл `.env` в корне проекта или экспортируйте переменные в окружение:

- `TELEGRAM_TOKEN` — токен Telegram-бота
- `OPENAI_API_KEY` — ключ OpenAI (для редактирования изображений)
- `GOOGLE_API_KEY` — ключ Google Vision (если используете Google-интеграцию)

## Установка зависимостей

Установите минимальный набор зависимостей. По необходимости зафиксируйте версии.

```powershell
python -m pip install --upgrade pip
pip install aiogram opencv-python pillow python-dotenv aiohttp
```

Рекомендуется использовать виртуальное окружение на Windows:

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt  # если вы добавите requirements.txt
```

## Конфигурационные константы

Используемые соглашения (см. `bot.py`):

- `MAX_IMAGE_SIZE = 4 * 1024 * 1024` — максимальный размер входного изображения (4 МБ)
- `MAX_RETRIES = 3` — число попыток при обращении к внешним API
- `CONCURRENT_REQUESTS_LIMIT = 10` — лимит одновременных запросов (семафор)

## Как это работает (вкратце)

1. Пользователь отправляет фото боту.
2. Бот проверяет размер и сохраняет файл как `tmp_{chat_id}_{message_id}.jpg` во временной директории.
3. Бот предлагает выбрать сервис (OpenAI / Google Vision) и ввести промпт для редактирования.
4. Обработка выполняется асинхронно (длительные операции — в executor).
5. Результат сохраняется как `{original_path}.edited.png` и отправляется пользователю.
6. Временные файлы удаляются в блоках `finally`.

## FSM / последовательность диалога

- Используется aiogram 3.x FSM (см. `bot.py`)
- Состояния: `choosing_service` → `waiting_for_prompt` → `waiting_for_result`

## Рекомендации по промптам

Примеры эффективных промптов (подбирайте под конкретный сервис):

- Стиль: «Преобразуй фото в стиле акварели.»
- Цветокоррекция: «Сделай фото более контрастным и насыщенным.»
- Замена фона: «Замени фон на закат над морем.»
- Улучшение портрета: «Сделай лицо более резким и убери мелкие дефекты.»

Советы:

- Формулируйте одну основную задачу в промпте.
- Учитывайте ограничения API (размер изображения, поддерживаемые эффекты).

## Производительность и рекомендации по продакшену

- Сжимайте большие изображения перед отправкой в API.
- Используйте `asyncio.Semaphore` для ограничения параллельных запросов.
- Кэшируйте часто повторяющиеся результаты, чтобы сократить число вызовов API.
- Устанавливайте таймауты сети: например, 180 с для OpenAI image edits, 60 с для загрузки изображений.

## Обработка ошибок и повторные попытки

- Оборачивайте вызовы внешних API в логику повторных попыток (до `MAX_RETRIES`).
- Сообщайте пользователю о проблемах и предлагайте повторить запрос.
- Всегда удаляйте временные файлы в блоке `finally`, чтобы не накапливать мусор на диске.

## Советы для разработки

- Проверяйте переменные окружения перед запуском бота.
- Включите логирование для мониторинга запросов, задержек и ошибок.
- Подумайте о ограничении частоты запросов на пользователя для защиты от злоупотреблений.

## Устранение неполадок

- Бот не запускается: проверьте правильность `TELEGRAM_TOKEN`.
- Ошибки при обработке изображений: проверьте `OPENAI_API_KEY` / `GOOGLE_API_KEY` и доступные квоты.
- Слишком много параллельных запросов: уменьшите `CONCURRENT_REQUESTS_LIMIT`.

## Возможные улучшения (предложения)

- Добавить `requirements.txt` с зафиксированными версиями и CI-проверки.
- Написать модульные тесты для обработки промптов и жизненного цикла временных файлов.
- Добавить `Dockerfile` для контейнерного деплоя бота.

## Лицензия

В репозитории не задана явная лицензия. Добавьте файл лицензии, если планируете публиковать проект.

---

Если хотите, я могу также:

- создать `requirements.txt` с зафиксированными зависимостями,
- добавить минимальный `Procfile` / `Dockerfile`, или
- добавить скрипт `run_bot.ps1` для удобного запуска бота в Windows.
